!function(e){"function"==typeof define&&define.amd?define(["jquery","./core","./scrollbar","./touch"],e):e(jQuery,Formstone)}(function(e,t){"use strict";function s(){K=t.$body}function i(s){s.multiple=this.prop("multiple"),s.disabled=this.is(":disabled")||this.is("[readonly]"),s.lastIndex=!1,s.multiple?s.links=!1:s.external&&(s.links=!0);var i=this.find("[selected]").not(":disabled"),l=this.find(":selected").not(":disabled"),o=l.text(),d=this.find("option").index(l);s.multiple||""===s.label||i.length?s.label="":(l=this.prepend('<option value="" class="'+E.item_placeholder+'" selected>'+s.label+"</option>"),o=s.label,d=0);var n=this.find("option, optgroup"),p=n.filter("option"),c=e("[for="+this.attr("id")+"]");s.tabIndex=this[0].tabIndex,this[0].tabIndex=-1,c.length&&(c[0].tabIndex=-1);var u=[E.base,s.theme,s.customClass];s.mobile||t.isMobile?u.push(E.mobile):s.cover&&u.push(E.cover),s.multiple&&u.push(E.multiple),s.disabled&&u.push(E.disabled);var f='<div class="'+u.join(" ")+'" tabindex="'+s.tabIndex+'"></div>',x="";s.multiple||(x+='<button type="button" class="'+E.selected+'" tabindex="-1">',x+=e("<span></span>").text(_(o,s.trim)).html(),x+="</button>"),x+='<div class="'+E.options+'">',x+="</div>",this.wrap(f).after(x),s.$dropdown=this.parent(I.base),s.$label=c,s.$allOptions=n,s.$options=p,s.$selected=s.$dropdown.find(I.selected),s.$wrapper=s.$dropdown.find(I.options),s.$placeholder=s.$dropdown.find(I.placeholder),s.index=-1,s.closed=!0,s.focused=!1,a(s),s.links?this.attr("aria-hidden","true"):s.$selected.add(s.$wrapper).attr("aria-hidden","true"),s.multiple||w(d,s),void 0!==e.fn.fsScrollbar&&s.$wrapper.fsScrollbar({theme:s.theme}),s.$selected.on(S.click,s,r),s.$dropdown.on(S.click,I.item,s,b).on(S.close,s,m),this.on(S.change,s,$),t.isMobile||(this.on(S.focusIn,s,function(e){e.data.$dropdown.trigger(S.raw.focus)}),s.$dropdown.on(S.focusIn,s,h).on(S.focusOut,s,v))}function l(t){t.$dropdown.hasClass(E.open)&&t.$selected.trigger(S.click),void 0!==e.fn.fsScrollbar&&t.$wrapper.fsScrollbar("destroy"),t.links&&this.removeAttr("aria-hidden"),t.$el[0].tabIndex=t.tabIndex,t.$label.length&&(t.$label[0].tabIndex=t.tabIndex),t.$dropdown.off(S.namespace),t.$options.off(S.namespace),t.$placeholder.remove(),t.$selected.remove(),t.$wrapper.remove(),t.$el.off(S.namespace).show().unwrap()}function o(e,t){if("undefined"!=typeof t){var s=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(s).addClass(E.item_disabled),e.$options.eq(s).prop("disabled",!0)}else e.$dropdown.hasClass(E.open)&&e.$selected.trigger(S.click),e.$dropdown.addClass(E.disabled),e.$el.prop("disabled",!0),e.disabled=!0}function d(e,t){if("undefined"!=typeof t){var s=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(s).removeClass(E.item_disabled),e.$options.eq(s).prop("disabled",!1)}else e.$dropdown.removeClass(E.disabled),e.$el.prop("disabled",!1),e.disabled=!1}function n(t){void 0!==e.fn.fsScrollbar&&t.$wrapper.fsScrollbar("destroy");var s=t.index;t.$allOptions=t.$el.find("option, optgroup"),t.$options=t.$allOptions.filter("option"),t.index=-1,s=t.$options.index(t.$options.filter(":selected")),a(t),t.multiple||w(s,t),void 0!==e.fn.fsScrollbar&&t.$wrapper.fsScrollbar()}function a(t){for(var s="",i=0,l=0,o=t.$allOptions.length;o>l;l++){var d=t.$allOptions.eq(l),n=[];if("OPTGROUP"===d[0].tagName)n.push(E.group),d.is(":disabled")&&n.push(E.disabled),s+='<span class="'+n.join(" ")+'">'+d.attr("label")+"</span>";else{var a=d.val(),r=d.data("label"),p=t.links?"a":'button type="button"';d.attr("value")||d.attr("value",a),n.push(E.item),d.hasClass(E.item_placeholder)&&(n.push(E.item_placeholder),p="span"),d.is(":selected")&&n.push(E.item_selected),d.is(":disabled")&&n.push(E.item_disabled),s+="<"+p+' class="'+n.join(" ")+'"',t.links?"span"===p?s+=' aria-hidden="true"':(s+=' href="'+a+'"',t.external&&(s+=' target="_blank"')):s+=' data-value="'+a+'"',s+=' tabindex="-1">',s+=r?r:q.decodeEntities(_(d.text(),t.trim)),s+="</"+p+">",i++}}t.$items=t.$wrapper.html(e.parseHTML(s)).find(I.item)}function r(e){q.killEvent(e);var s=e.data;if(!s.disabled)if(s.mobile||!t.isMobile||t.isFirefoxMobile||t.isIEMobile)s.closed?c(s):u(s);else{var i=s.$el[0];if(M.createEvent){var l=M.createEvent("MouseEvents");l.initMouseEvent("mousedown",!1,!0,T,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(l)}else i.fireEvent&&i.fireEvent("onmousedown")}p(s)}function p(t){e(I.base).not(t.$dropdown).trigger(S.close,[t])}function c(e){if(e.closed){var t=O.height(),s=e.$wrapper.outerHeight(!0),i=e.$dropdown[0].getBoundingClientRect();i.bottom+s>t-e.bottomEdge&&e.$dropdown.addClass(E.bottom),K.on(S.click+e.dotGuid,":not("+I.options+")",e,f),e.$dropdown.trigger(S.focusIn),e.$dropdown.addClass(E.open),g(e),e.closed=!1}}function u(e){e&&!e.closed&&(K.off(S.click+e.dotGuid),e.$dropdown.removeClass([E.open,E.bottom].join(" ")),e.closed=!0)}function f(t){q.killEvent(t);var s=t.data;s&&0===e(t.currentTarget).parents(I.base).length&&(u(s),s.$dropdown.trigger(S.focusOut))}function m(e){var t=e.data;t&&(u(t),t.$dropdown.trigger(S.focusOut))}function b(t){var s=e(this),i=t.data;if(q.killEvent(t),!i.disabled){var l=i.$items.index(s);i.focusIndex=l,i.$wrapper.is(":visible")&&(w(l,i,t.shiftKey,t.metaKey||t.ctrlKey),C(i)),i.multiple||u(i),i.$dropdown.trigger(S.focus)}}function $(t,s){var i=(e(this),t.data);if(!s&&!i.multiple){var l=i.$options.index(i.$options.filter(":selected"));i.focusIndex=l,w(l,i),C(i)}}function h(t){q.killEvent(t);var s=(e(t.currentTarget),t.data);s.disabled||s.multiple||s.focused||(p(s),s.focused=!0,s.focusIndex=s.index,s.input="",s.$dropdown.addClass(E.focus).on(S.keyDown+s.dotGuid,s,x))}function v(t,s){q.killEvent(t);var i=(e(t.currentTarget),t.data);i.focused&&i.closed&&(i.focused=!1,i.$dropdown.removeClass(E.focus).off(S.keyDown+i.dotGuid),i.multiple||(u(i),i.index!==i.focusIndex&&(C(i),i.focusIndex=i.index)))}function x(s){var i=s.data;if(i.keyTimer=q.startTimer(i.keyTimer,1e3,function(){i.input=""}),13===s.keyCode)i.closed||(u(i),w(i.index,i)),C(i);else if(!(9===s.keyCode||s.metaKey||s.altKey||s.ctrlKey||s.shiftKey)){q.killEvent(s);var l=i.$items.length-1,o=i.index<0?0:i.index;if(e.inArray(s.keyCode,t.isFirefox?[38,40,37,39]:[38,40])>-1)o+=38===s.keyCode||t.isFirefox&&37===s.keyCode?-1:1,0>o&&(o=0),o>l&&(o=l);else{var d,n,a=String.fromCharCode(s.keyCode).toUpperCase();for(i.input+=a,n=i.index+1;l>=n;n++)if(d=i.$options.eq(n).text().substr(0,i.input.length).toUpperCase(),d===i.input){o=n;break}if(0>o||o===i.index)for(n=0;l>=n;n++)if(d=i.$options.eq(n).text().substr(0,i.input.length).toUpperCase(),d===i.input){o=n;break}}o>=0&&(w(o,i),g(i))}}function w(e,s,i,l){var o=s.$items.eq(e),d=s.$options.eq(e),n=o.hasClass(E.item_selected),a=o.hasClass(E.item_disabled);if(!a)if(s.multiple)if(t.isMobile)a||(n?(d.prop("selected",null),o.removeClass(E.item_selected)):(d.prop("selected",!0),o.addClass(E.item_selected)));else if(i&&s.lastIndex!==!1){var r=s.lastIndex>e?e:s.lastIndex,p=(s.lastIndex>e?s.lastIndex:e)+1;s.$options.prop("selected",null),s.$items.filter(I.item_selected).removeClass(E.item_selected),s.$options.slice(r,p).not("[disabled]").prop("selected",!0),s.$items.slice(r,p).not(I.item_disabled).addClass(E.item_selected)}else l?(n?(d.prop("selected",null),o.removeClass(E.item_selected)):(d.prop("selected",!0),o.addClass(E.item_selected)),s.lastIndex=e):(s.$options.prop("selected",null),s.$items.filter(I.item_selected).removeClass(E.item_selected),d.prop("selected",!0),o.addClass(E.item_selected),s.lastIndex=e);else if(e>-1&&e<s.$items.length){if(e!==s.index){var c=d.data("label")||o.html();s.$selected.html(c).removeClass(I.item_placeholder),s.$items.filter(I.item_selected).removeClass(E.item_selected),s.$el[0].selectedIndex=e,o.addClass(E.item_selected),s.index=e}}else""!==s.label&&s.$selected.html(s.label)}function g(t){var s=t.$items.eq(t.index),i=t.index>=0&&!s.hasClass(E.item_placeholder)?s.position():{left:0,top:0},l=(t.$wrapper.outerHeight()-s.outerHeight())/2;void 0!==e.fn.fsScrollbar?t.$wrapper.fsScrollbar("resize").fsScrollbar("scroll",t.$wrapper.find(".fs-scrollbar-content").scrollTop()+i.top):t.$wrapper.scrollTop(t.$wrapper.scrollTop()+i.top-l)}function C(e){e.links?k(e):e.$el.trigger(S.raw.change,[!0])}function k(e){var t=e.$el.val();e.external?T.open(t):T.location.href=t}function _(e,t){return 0===t?e:e.length>t?e.substring(0,t)+"...":e}var y=t.Plugin("dropdown",{widget:!0,defaults:{bottomEdge:0,cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,theme:"fs-light",trim:0},methods:{_setup:s,_construct:i,_destruct:l,disable:o,enable:d,update:n,open:c,close:u},classes:["cover","bottom","multiple","mobile","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{close:"close"}}),I=y.classes,E=I.raw,S=y.events,q=y.functions,T=t.window,O=t.$window,M=t.document,K=null});